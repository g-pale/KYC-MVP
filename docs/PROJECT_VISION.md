# Видение проекта: KYC-сервис (MVP)

## 1. Общее видение

### 1.1 Цель проекта
Создание масштабируемого, безопасного и соответственного требованиям GDPR бэкенд-сервиса для верификации личности пользователей через биометрическую идентификацию. Сервис должен обеспечивать высокую точность верификации, быструю обработку запросов и готовность к расширению функционала.

### 1.2 Ключевые принципы
- **Безопасность**: Минимизация хранения PII данных, шифрование в покое и при передаче
- **Соответствие**: GDPR, локальные требования по защите персональных данных
- **Масштабируемость**: Асинхронная обработка, готовность к горизонтальному масштабированию
- **Надёжность**: Обработка ошибок, fallback на ручную модерацию
- **Производительность**: Оптимизация времени ответа, кэширование где возможно

---

## 2. Архитектура системы

### 2.1 Высокоуровневая архитектура

```
┌─────────────┐
│   Mobile    │
│   Client    │
└──────┬──────┘
       │ HTTPS + JWT
       │
┌──────▼─────────────────────────────────────┐
│         FastAPI Application                │
│  ┌──────────────────────────────────────┐  │
│  │  API Layer (Endpoints)               │  │
│  │  - POST /kyc/verification            │  │
│  │  - GET /kyc/verification/{id}        │  │
│  └──────────────┬───────────────────────┘  │
│                 │                           │
│  ┌──────────────▼───────────────────────┐  │
│  │  Service Layer                       │  │
│  │  - VerificationService                │  │
│  │  - MediaProcessingService             │  │
│  │  - AzureFaceService                   │  │
│  └──────────────┬───────────────────────┘  │
│                 │                           │
│  ┌──────────────▼───────────────────────┐  │
│  │  Background Tasks / Celery Workers   │  │
│  │  - Async verification processing     │  │
│  └──────────────┬───────────────────────┘  │
└─────────────────┼──────────────────────────┘
                  │
        ┌─────────┼─────────┐
        │         │         │
┌───────▼──┐ ┌────▼────┐ ┌──▼──────────┐
│  MySQL   │ │  Redis  │ │ Azure Blob  │
│          │ │ (Queue) │ │  Storage    │
└──────────┘ └─────────┘ └─────────────┘
                  │
        ┌─────────▼─────────┐
        │  Azure Face API   │
        │  Azure Form       │
        │  Recognizer       │
        └───────────────────┘
```

### 2.2 Поток данных

1. **Загрузка данных**:
   - Клиент отправляет multipart/form-data (фото документа + селфи/видео)
   - API валидирует файлы (размер, формат, наличие лица)
   - Файлы сохраняются во временное хранилище (Azure Blob Storage)
   - Создаётся запись в БД со статусом `pending`
   - Возвращается `verification_id`

2. **Асинхронная обработка**:
   - Background task/Celery worker получает задачу
   - Извлечение кадров из видео (если применимо)
   - Вызов Azure Face API: Detect для обоих изображений
   - Вызов Azure Face API: Verify для сравнения
   - Обработка результата и обновление статуса

3. **Получение результата**:
   - Клиент запрашивает статус по `verification_id`
   - Возвращается текущий статус и метаданные

4. **Очистка данных**:
   - После завершения верификации файлы удаляются из Blob Storage
   - (Опционально) Метаданные сохраняются в БД согласно политике хранения

---

## 3. Технологический стек

### 3.1 Основной стек (рекомендуемый)

#### Backend Framework
**FastAPI** (рекомендуется) ✅
- **Преимущества**:
  - Нативная поддержка асинхронности (async/await)
  - Автоматическая генерация OpenAPI/Swagger документации
  - Высокая производительность (сопоставима с Node.js и Go)
  - Встроенная валидация через Pydantic
  - Простота интеграции с Celery
- **Альтернатива**: Django REST Framework (DRF)
  - Использовать только если команда более знакома с Django
  - Требует дополнительной настройки для асинхронности

#### База данных
**PostgreSQL** (рекомендуется) ✅
- **Преимущества перед MySQL**:
  - Лучшая поддержка JSON полей (для метаданных)
  - Более мощные возможности для работы с UUID
  - Лучшая производительность для сложных запросов
  - Поддержка полнотекстового поиска
  - Отличная поддержка в Python экосистеме
- **Для MVP**: SQLite (если нужна простота развёртывания)
- **Для production**: PostgreSQL на Azure Database for PostgreSQL или managed service

#### Хранилище файлов
**Azure Blob Storage** ✅
- **Преимущества**:
  - Нативная интеграция с Azure Face API
  - Lifecycle policies для автоматического удаления
  - Шифрование на уровне хранилища
  - CDN интеграция (если понадобится)
  - Низкая стоимость для временного хранения
- **Настройка**:
  - Container с TTL политикой (автоудаление через N дней)
  - Private access (только через SAS tokens)
  - Soft delete enabled для восстановления при ошибках

#### Очередь задач
**Celery + Redis** (рекомендуется) ✅
- **Преимущества**:
  - Проверенное решение для асинхронных задач
  - Retry механизмы
  - Мониторинг через Flower
  - Масштабирование через несколько workers
- **Альтернатива**: FastAPI BackgroundTasks
  - Использовать только для MVP с низкой нагрузкой
  - Не подходит для production с высокой нагрузкой
- **Redis**:
  - Использовать Azure Cache for Redis (managed)
  - Или self-hosted Redis в контейнере

#### Azure Services
**Azure Face API** ✅
- Cognitive Services Face API
- Регион: выбирать ближайший к серверу
- Тариф: Free tier для MVP, затем Standard S0

**Azure Form Recognizer** (опционально, для будущего расширения)
- Извлечение данных из документов (ФИО, дата рождения, номер документа)

### 3.2 Дополнительные инструменты

#### Обработка медиа
- **OpenCV** (cv2): Извлечение кадров из видео, предобработка изображений
- **Pillow (PIL)**: Работа с изображениями, ресайз, валидация
- **FFmpeg** (через subprocess или python-ffmpeg): Альтернатива для извлечения кадров

#### Безопасность
- **python-jose**: JWT токены
- **passlib**: Хеширование паролей (если нужна аутентификация)
- **cryptography**: Дополнительное шифрование при необходимости

#### Мониторинг и логирование
- **Sentry**: Отслеживание ошибок
- **Prometheus + Grafana**: Метрики производительности
- **ELK Stack** или **Azure Application Insights**: Централизованное логирование

#### Тестирование
- **pytest**: Unit и integration тесты
- **pytest-asyncio**: Тесты для async кода
- **httpx**: Тестирование API endpoints
- **factory-boy**: Генерация тестовых данных

#### DevOps
- **Docker**: Контейнеризация приложения
- **Docker Compose**: Локальная разработка
- **GitHub Actions / Azure DevOps**: CI/CD
- **Terraform** или **Azure ARM/Bicep**: Infrastructure as Code

---

## 4. Детальный план разработки

### Этап 1: Настройка проекта и инфраструктуры (1-2 дня)

#### 1.1 Инициализация проекта
- Создание структуры проекта
- Настройка виртуального окружения (venv или poetry)
- Создание `requirements.txt` или `pyproject.toml`
- Настройка `.env` для переменных окружения
- Создание `.gitignore`

#### 1.2 Структура проекта
```
kyc-service/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI app
│   ├── config.py               # Конфигурация
│   ├── database.py             # DB connection
│   ├── models/                 # SQLAlchemy models
│   │   ├── __init__.py
│   │   └── verification.py
│   ├── schemas/                # Pydantic schemas
│   │   ├── __init__.py
│   │   └── verification.py
│   ├── api/                    # API endpoints
│   │   ├── __init__.py
│   │   └── verification.py
│   ├── services/               # Business logic
│   │   ├── __init__.py
│   │   ├── verification_service.py
│   │   ├── media_service.py
│   │   └── azure_face_service.py
│   ├── tasks/                  # Celery tasks
│   │   ├── __init__.py
│   │   └── verification_tasks.py
│   └── utils/                  # Utilities
│       ├── __init__.py
│       ├── security.py
│       └── media_processing.py
├── tests/
│   ├── __init__.py
│   ├── test_api.py
│   ├── test_services.py
│   └── conftest.py
├── alembic/                    # DB migrations
├── docker/
│   ├── Dockerfile
│   └── docker-compose.yml
├── .env.example
├── requirements.txt
├── README.md
└── PROJECT_VISION.md
```

#### 1.3 Настройка базы данных
- Установка SQLAlchemy + Alembic
- Создание модели `Verification`
- Настройка миграций
- Подключение к БД (PostgreSQL/SQLite)

#### 1.4 Настройка Azure
- Создание Azure Cognitive Services Face API ресурса
- Получение ключей и endpoint
- Настройка Azure Blob Storage
- Создание контейнера с lifecycle policy

### Этап 2: Реализация загрузки файлов (2-3 дня)

#### 2.1 API endpoint для загрузки
- `POST /kyc/verification`
- Валидация multipart/form-data
- Проверка типов файлов (image/jpeg, image/png, video/mp4)
- Проверка размера файлов
- Базовая проверка наличия лица (опционально, через Azure)

#### 2.2 Интеграция с Azure Blob Storage
- Сервис для загрузки файлов в Blob Storage
- Генерация SAS tokens для временного доступа
- Сохранение метаданных (путь, размер, тип)

#### 2.3 Создание записи в БД
- Сохранение `verification_id` (UUID)
- Статус: `pending`
- Метаданные файлов
- Timestamps

### Этап 3: Обработка медиа (2-3 дня)

#### 3.1 Обработка изображений
- Валидация качества изображения
- Ресайз при необходимости (Azure Face API требования)
- Конвертация форматов
- Извлечение метаданных (EXIF)

#### 3.2 Обработка видео
- Извлечение кадров через OpenCV или FFmpeg
- Выбор лучших кадров (с наибольшим лицом)
- Сохранение кадров во временное хранилище
- Очистка временных файлов

#### 3.3 Оптимизация
- Сжатие изображений для уменьшения размера
- Кэширование обработанных кадров (если нужно повторное использование)

### Этап 4: Интеграция с Azure Face API (3-4 дня)

#### 4.1 Сервис для работы с Azure Face API
- Класс `AzureFaceService`
- Метод `detect_face()`: получение faceId
- Метод `verify_faces()`: сравнение двух faceId
- Обработка ошибок API (rate limits, таймауты)

#### 4.2 Логика верификации
- Detect для фото документа
- Detect для селфи/видео кадра
- Verify для сравнения
- Интерпретация результата (confidence threshold)

#### 4.3 Обработка edge cases
- Несколько лиц на изображении
- Отсутствие лица
- Низкое качество изображения
- Таймауты Azure API
- Rate limiting

### Этап 5: Асинхронная обработка (2-3 дня)

#### 5.1 Настройка Celery
- Конфигурация Celery с Redis
- Создание Celery app
- Настройка task routing

#### 5.2 Celery task для верификации
- `process_verification_task(verification_id)`
- Загрузка файлов из Blob Storage
- Обработка медиа
- Вызов Azure Face API
- Обновление статуса в БД
- Очистка файлов

#### 5.3 Интеграция с FastAPI
- Запуск task после создания verification
- Endpoint для проверки статуса
- Webhook для уведомлений (опционально)

### Этап 6: Безопасность и соответствие (2-3 дня)

#### 6.1 Аутентификация
- JWT токены
- Middleware для проверки токенов
- Роли и права доступа (если нужно)

#### 6.2 Защита данных
- Шифрование чувствительных данных в БД
- Безопасное хранение секретов (Azure Key Vault или env vars)
- HTTPS только
- Валидация всех входных данных

#### 6.3 GDPR compliance
- Автоматическое удаление файлов после обработки
- Политика хранения метаданных
- Логирование доступа к данным
- Endpoint для удаления данных по запросу пользователя

### Этап 7: Обработка ошибок и статусы (1-2 дня)

#### 7.1 Статусы верификации
- `pending`: Ожидает обработки
- `processing`: В процессе обработки
- `verified`: Успешно верифицирован
- `not_verified`: Не прошёл верификацию
- `manual_review`: Требует ручной проверки
- `error`: Ошибка при обработке

#### 7.2 Обработка ошибок
- Таймауты Azure API → `manual_review`
- Низкое качество фото → `manual_review`
- Несколько лиц → `manual_review`
- Отсутствие лица → `not_verified`
- Технические ошибки → `error` + логирование

#### 7.3 Retry механизм
- Автоматические повторы для временных ошибок
- Exponential backoff
- Максимальное количество попыток

### Этап 8: Тестирование (2-3 дня)

#### 8.1 Unit тесты
- Тесты сервисов
- Тесты утилит
- Моки для Azure API

#### 8.2 Integration тесты
- Тесты API endpoints
- Тесты Celery tasks
- Тесты с тестовой БД

#### 8.3 E2E тесты
- Полный цикл верификации
- Тестирование с реальными изображениями
- Нагрузочное тестирование

### Этап 9: Документация и деплой (1-2 дня)

#### 9.1 API документация
- Swagger UI (автоматически через FastAPI)
- ReDoc
- Примеры запросов
- Описание ошибок

#### 9.2 README
- Установка и настройка
- Переменные окружения
- Запуск локально
- Запуск в Docker

#### 9.3 Деплой
- Docker образ
- Docker Compose для локальной разработки
- CI/CD pipeline
- Инструкции по деплою на Azure

---

## 5. Рекомендации по сервисам и инструментам

### 5.1 Облачная инфраструктура (Azure)

#### Для MVP (минимальные затраты)
- **Azure App Service** (Basic tier): Хостинг FastAPI приложения
- **Azure Database for PostgreSQL** (Basic tier): База данных
- **Azure Blob Storage** (Hot tier): Хранение файлов
- **Azure Cache for Redis** (Basic C0): Очередь для Celery
- **Azure Cognitive Services Face API** (Free tier): Верификация лиц

#### Для Production
- **Azure Kubernetes Service (AKS)**: Оркестрация контейнеров (если нужен масштаб)
- **Azure Container Instances**: Для Celery workers
- **Azure Application Gateway**: Load balancer + WAF
- **Azure Key Vault**: Хранение секретов
- **Azure Monitor + Application Insights**: Мониторинг и логирование
- **Azure CDN**: Для статических ресурсов (если нужно)

### 5.2 Альтернативные облачные решения

#### AWS
- **EC2 / ECS / EKS**: Хостинг приложения
- **RDS PostgreSQL**: База данных
- **S3**: Хранение файлов
- **ElastiCache Redis**: Очередь
- **Amazon Rekognition**: Альтернатива Azure Face API (но проект использует Azure)

#### Google Cloud
- **Cloud Run**: Serverless контейнеры
- **Cloud SQL PostgreSQL**: База данных
- **Cloud Storage**: Хранение файлов
- **Memorystore Redis**: Очередь
- **Vertex AI Vision**: Альтернатива для распознавания лиц

### 5.3 Локальная разработка

- **Docker Desktop**: Для запуска контейнеров
- **Docker Compose**: Оркестрация локальных сервисов (PostgreSQL, Redis)
- **ngrok** или **localtunnel**: Для тестирования webhooks локально
- **Postman** или **Insomnia**: Тестирование API

### 5.4 Мониторинг и аналитика

- **Sentry**: Отслеживание ошибок в production
- **Grafana + Prometheus**: Метрики и дашборды
- **Azure Application Insights**: Интеграция с Azure экосистемой
- **Logtail** или **Datadog**: Централизованное логирование

### 5.5 CI/CD

- **GitHub Actions**: Бесплатно для публичных репозиториев
- **Azure DevOps Pipelines**: Интеграция с Azure
- **GitLab CI/CD**: Если используете GitLab
- **Jenkins**: Self-hosted решение

---

## 6. Современные практики и тренды

### 6.1 Архитектурные паттерны

- **Repository Pattern**: Абстракция доступа к данным
- **Service Layer**: Бизнес-логика отдельно от API
- **Dependency Injection**: Через FastAPI Depends
- **Event-Driven**: Для будущего расширения (Kafka, Azure Service Bus)

### 6.2 Безопасность

- **OWASP Top 10**: Следование рекомендациям
- **Rate Limiting**: Защита от DDoS (через slowapi или nginx)
- **Input Validation**: Строгая валидация всех входных данных
- **Secrets Management**: Azure Key Vault или HashiCorp Vault
- **Audit Logging**: Логирование всех операций с PII

### 6.3 Производительность

- **Async/Await**: Нативная поддержка в FastAPI
- **Connection Pooling**: Для БД и внешних API
- **Caching**: Redis для часто запрашиваемых данных
- **CDN**: Для статических ресурсов (если нужно)
- **Database Indexing**: Оптимизация запросов

### 6.4 Масштабируемость

- **Horizontal Scaling**: Через несколько инстансов приложения
- **Worker Scaling**: Независимое масштабирование Celery workers
- **Database Read Replicas**: Для распределения нагрузки чтения
- **Message Queue**: Для асинхронной обработки (уже есть через Celery)

### 6.5 Соответствие требованиям

- **GDPR**:
  - Право на удаление данных
  - Минимизация хранения PII
  - Шифрование данных
  - Логирование доступа
- **SOC 2**: Для enterprise клиентов (будущее)
- **ISO 27001**: Сертификация безопасности (будущее)

---

## 7. Риски и митигация

### 7.1 Технические риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Ограничения Azure Face API Free tier | Высокая | Среднее | Мониторинг использования, переход на платный тариф |
| Таймауты Azure API | Средняя | Среднее | Retry механизм, fallback на manual_review |
| Проблемы с качеством изображений | Высокая | Низкое | Предварительная валидация, улучшение качества через OpenCV |
| Утечка данных | Низкая | Критическое | Шифрование, аудит доступа, автоматическое удаление |

### 7.2 Бизнес-риски

- **Высокая стоимость Azure API**: Мониторинг использования, оптимизация вызовов
- **Ложные срабатывания**: Настройка confidence threshold, ручная модерация
- **Масштабирование**: Архитектура готова к горизонтальному масштабированию

---

## 8. Метрики успеха MVP

### 8.1 Производительность
- Время обработки верификации: < 30 секунд (для изображений)
- Время обработки видео: < 2 минут
- Uptime: > 99%
- API response time: < 200ms (для статусных запросов)

### 8.2 Точность
- False Positive Rate: < 5%
- False Negative Rate: < 10%
- Manual Review Rate: < 20%

### 8.3 Безопасность
- 0 утечек данных
- 100% HTTPS трафика
- Все секреты в Key Vault

---

## 9. Будущие расширения

### 9.1 Функциональные расширения
- **KYB (Know Your Business)**: Верификация юридических лиц
- **Liveness Detection**: Определение живости (через Azure Face API или специализированные решения)
- **Document OCR**: Извлечение данных из документов (Azure Form Recognizer)
- **Multi-document support**: Поддержка разных типов документов
- **Webhook notifications**: Уведомления клиентов о статусе
- **Admin panel**: Панель для ручной модерации

### 9.2 Технические улучшения
- **GraphQL API**: Альтернатива REST
- **gRPC**: Для внутренней коммуникации между сервисами
- **Event Sourcing**: Для аудита и восстановления состояния
- **Microservices**: Разделение на отдельные сервисы (media processing, verification, etc.)
- **Machine Learning**: Собственные модели для улучшения точности

---

## 10. Заключение

Данное видение проекта обеспечивает:
- ✅ Современный технологический стек
- ✅ Масштабируемую архитектуру
- ✅ Соответствие требованиям безопасности и GDPR
- ✅ Готовность к расширению функционала
- ✅ Чёткий план разработки MVP

Проект готов к началу разработки с фокусом на качество, безопасность и производительность.

